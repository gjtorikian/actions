name: Release and publish

on:
  workflow_call:
    secrets:
      gh_token:
        required: true
    outputs:
      version:
        description: "Full version number"
        value: ${{ jobs.release.outputs.version }}
      major:
        description: "Major version number"
        value: ${{ jobs.release.outputs.major }}
    inputs:
      version_filepath:
        default: package.json
        type: string
      prepare:
        required: false
        default: false
        type: boolean
      release:
        required: false
        default: false
        type: boolean
      build_dist:
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  actions: write
  id-token: write

jobs:
  create-release-pr:
    if: ${{ inputs.prepare }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-tags: true

      - name: Configure Git
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Actions Auto Build"

      - name: Get current version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        id: check-tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get previous tag
        if: steps.check-tag.outputs.exists == 'false'
        id: prev-tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=${PREV_TAG}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        if: steps.check-tag.outputs.exists == 'false'
        id: notes
        env:
          GH_TOKEN: ${{ secrets.gh_token }}
        run: |
          if [ -n "${{ steps.prev-tag.outputs.tag }}" ]; then
            NOTES=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name='v${{ steps.version.outputs.version }}' \
              -f previous_tag_name='${{ steps.prev-tag.outputs.tag }}' \
              | jq -r ".body")
          else
            NOTES="Initial release"
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update changelog
        if: steps.check-tag.outputs.exists == 'false'
        shell: bash
        run: |
          # Prepend to CHANGELOG.md
          echo "## v${{ steps.version.outputs.version }} - $(date +%Y-%m-%d)" > CHANGELOG.tmp
          echo "" >> CHANGELOG.tmp
          echo "${{ steps.notes.outputs.notes }}" >> CHANGELOG.tmp
          echo "" >> CHANGELOG.tmp
          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> CHANGELOG.tmp
          fi
          mv CHANGELOG.tmp CHANGELOG.md

      - name: Create release branch and PR
        id: cpr
        if: steps.check-tag.outputs.exists == 'false'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "[skip test] update changelog for v${{ steps.version.outputs.version }}"
          title: "[skip test] Release v${{ steps.version.outputs.version }}"
          body: >
            This is an automated PR to build the latest changelog. Upon merging,
            a new release will be created and published to npm.<br/><br/>
            Due to security considerations, PRs created by GitHub Actions cannot
            be merged automatically. Please review the changes and merge the PR.<br/><br/>
            If you require the test suites to run, you can close the PR and reopen it to trigger
            those workflows.
          delete-branch: true
          labels: release
          branch: "release/v${{ steps.version.outputs.version }}"

      - name: Enable Pull Request Automerge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.gh_token }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}

  release:
    if: ${{ inputs.release }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      major: ${{ steps.version.outputs.major }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: gjtorikian/actions/setup-languages/node@main

      - name: Get version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT

      - name: Build dist
        if: ${{ inputs.build_dist }}
        run: npm run build

      - name: Commit dist
        if: ${{ inputs.build_dist }}
        env:
          GH_TOKEN: ${{ secrets.gh_token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f dist/
          git diff --cached --quiet || git commit -m "build dist for v${{ steps.version.outputs.version }}"
          git push origin main

      - name: Create and push tag
        run: |
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.gh_token }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --generate-notes

      - name: Build and publish to npm
        run: |
          npm run package
          npm publish --provenance --access public
